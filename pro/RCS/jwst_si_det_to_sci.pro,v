head	1.3;
access;
symbols;
locks
	penton:1.3; strict;
comment	@# @;


1.3
date	2018.04.10.14.23.57;	author penton;	state Exp;
branches;
next	1.2;

1.2
date	2018.03.15.17.38.58;	author penton;	state Exp;
branches;
next	1.1;

1.1
date	2018.03.15.15.22.37;	author penton;	state Exp;
branches;
next	;


desc
@new det to sci
@


1.3
log
@SI DET to SCI
@
text
@function jwst_si_det_to_sci,xydet,si,apername,verbose=verbose,debug=debug,$
	XDetRef=XDetRef,YDetRef=YDetRef,$
	XSciRef=XSciRef,YSciRef=YSciRef,DetSciParity=DetSciParity
	; convert from detector to science coordinates
	if n_elements(debug) ne 1 then debug=0
	if n_elements(verbose) ne 1 then verbose=0
	rcs_id='$Id: jwst_si_det_to_sci.pro,v 1.2 2018/03/15 17:38:58 penton Exp penton $'
	FF='(F12.6)'
	uSI=strupcase(strtrim(si,2))
	uAPER=strupcase(strtrim(apername,2))
	if verbose then message,/info,'Looking for SIAF info for '+uSI+' + '+uAPER
	xdet=reform(double(xydet[0,*]))
	ydet=reform(double(xydet[1,*]))
	n=n_elements(xdet)

	siaf=jwst_read_si_siaf(si,verbose=(verbose > 1))
	index=where(siaf.APERNAME eq uAPER,count)
	DetSciYAngle=(reform(siaf.DetSciYAngle[index]))[0]
	rDetSciYAngle=(DetSciYAngle)*!dtor
	DetSciParity=(reform(siaf.DetSciParity[index]))[0]
	;
	; Give priority to passed in XSciRef and YSciRef
	;
	XSciRef=(n_elements(XSciRef) eq 1 ? XSciRef : (reform(siaf.XSciRef[index]))[0])
	YSciRef=(n_elements(YSciRef) eq 1 ? YSciRef : (reform(siaf.YSciRef[index]))[0])
	XDetRef=(n_elements(XDetRef) eq 1 ? XDetRef : (reform(siaf.XDetRef[index]))[0])
	YDetRef=(n_elements(YDetRef) eq 1 ? YDetRef : (reform(siaf.YDetRef[index]))[0])

	psxSci=(reform(siaf.XSCISCALE[index]))[0]
	psySci=(reform(siaf.YSCISCALE[index]))[0]

	if verbose then begin
		message,/info,'APERNAME = '+uAPER+' ('+apername+')'
		message,/info,'[XSciref,YSciref] = ['+string1f(XSciRef,format=FF)+','+string1f(YSciRef,format=FF)+']'
		message,/info,'[XDetref,YDetref] = ['+string1f(XDetRef,format=FF)+','+string1f(YDetRef,format=FF)+']'
		message,/info,'Platescales [xSci,ySci] = ['+string1f(psxSci,format=FF)+','+string1f(psySci,format=FF)+']'
		message,/info,'DetSciYAngle = '+string1f(DetSciYAngle,format=FF)
		message,/info,'DetSciParity = '+string1i(DetSciParity)
	endif

	;eqn 1	xSci = [XSciRef] + [DetSciParity]((xDet â€“ [XDetRef]) * cos([DetSciYAngle]) +(yDet â€“ [YDetRef]) Â· sin([DetSciYAngle]))
	;eqn 2	ySci = [YSciRef] - (xDet â€“ [XDetRef]) Â· sin([DetSciYAngle]) + (yDet â€“ [YDetRef] * cos([DetSciYAngle])

	;
	; [Xdet,Ydet]=[0,0] is [XSciRef,YSciRef]
	;eqn 1	xSci = [XSciRef] + [DetSciParity]((xDet â€“ [XDetRef]) Â· cos([DetSciYAngle]) +(yDet â€“ [YDetRef]) Â· sin([DetSciYAngle]))
	;eqn 2	ySci = [YSciRef] - (xDet â€“ [XDetRef]) Â· sin([DetSciYAngle]) + (yDet â€“ [YDetRef]) Â· cos([DetSciYAngle])
	;
	; Convert to [xSci,ySci]
	;
	; From Colin's ISR:
	;
	; XSci âˆ’ XSciRef = DetSciParity[(XDetâˆ’XDetRef) * cos(DetSciYAngle)+ (YDetâˆ’YDetRef) *sin(DetSciYAngle)]
	; YSci âˆ’ YSciRef = âˆ’ (XDet âˆ’ XDetRef ) sin(DetSciYAngle) + (YDet âˆ’ YDetRef ) cos(DetSciYAngle)
	; XDet âˆ’ XDetRef = DetSciParity(XSci âˆ’ XSciRef ) cos(DetSciYAngle) âˆ’ (YSci âˆ’ YSciRef ) sin(DetSciYAngle)
	; YDet âˆ’ YDetRef = DetSciParity(XSci âˆ’ XSciRef ) sin(DetSciYAngle) + (YSci âˆ’ YSciRef ) cos(DetSciYAngle)

	;eqn 1	xSci = [XSciRef] + DetSciParity *(dx * cos([DetSciYAngle])  + dy * sin([DetSciYAngle]) )
	;eqn 2	ySci = [YSciRef] -                dx * sin([DetSciYAngle])  + dy * cos([DetSciYAngle])

	dx=(xdet-XDetRef)
	dy=(ydet-YDetRef)
	xSci = XSciRef + (DetSciParity)* ( dx * cos(rDetSciYAngle) +  dy * sin(rDetSciYAngle) )
	ySci = YSciRef -                   dx * sin(rDetSciYAngle)  + dy * cos(rDetSciYAngle)
	xySci=dblarr(2,n)
	xySci[0,*]=xSci
	xySci[1,*]=ySci
	xySCI={n:n,xSci:reform(xSci),ySci:reform(ySci),xySCI:xySCI,si:si,apername:apername,siaf:siaf,$
		dx:dx,dy:dy,DetSciParity:DetSciParity,DetSciYAngle:DetSciYAngle,rDetSciYAngle:rDetSciYAngle,$
		xdet:xdet,ydet:ydet,XSciRef:XSciRef,YSciRef:YSciRef,uAPER:uAPER}
	if debug then help,xySCI,/str
	return,xySCI
end
@


1.2
log
@added rcs_id
@
text
@d7 1
a7 1
	rcs_id='$Id: jwst_si_det_to_sci.pro,v 1.1 2018/03/15 15:22:37 penton Exp $'
d41 3
d46 2
a47 2
	;eqn 1	xSci = [XSciRef] + [DetSciParity]((xDet Ð [XDetRef]) á cos([DetSciYAngle]) +(yDet Ð [YDetRef]) á sin([DetSciYAngle]))
	;eqn 2	ySci = [YSciRef] - (xDet Ð [XDetRef]) á sin([DetSciYAngle]) + (yDet Ð [YDetRef]) á cos([DetSciYAngle])
d51 10
d63 2
a64 2
	xSci = XSciRef + (DetSciParity)* ( (dx * cos(rDetSciYAngle) + (dy * sin(rDetSciYAngle))
	ySci = YSciRef -                   (dx * sin(rDetSciYAngle) + (dy * cos(rDetSciYAngle)
d69 1
a69 1
		DetSciParity:DetSciParity,DetSciYAngle:DetSciYAngle,rDetSciYAngle:rDetSciYAngle,$
@


1.1
log
@Initial revision
@
text
@d7 1
a7 1
	rcs_id='$Id$'
d59 1
a59 1
	return,xySCI[0]
@
