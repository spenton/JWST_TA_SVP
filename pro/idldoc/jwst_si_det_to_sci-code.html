<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.6.1 on Sun Mar 18 21:49:09 2018 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>jwst_si_det_to_sci.pro (Documentation for /Users/penton/JWST/pro/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="jwst_si_det_to_sci.pro (Documentation for /Users/penton/JWST/pro/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="jwst_si_det_to_sci:source"></a>function jwst_si_det_to_sci,xydet,si,apername,verbose=verbose,debug=debug,$
	XDetRef=XDetRef,YDetRef=YDetRef,$
	XSciRef=XSciRef,YSciRef=YSciRef,DetSciParity=DetSciParity
	<span class="comments">; convert from detector to science coordinates</span>
	if n_elements(debug) ne 1 then debug=0
	if n_elements(verbose) ne 1 then verbose=0
	rcs_id='$Id: jwst_si_det_to_sci.pro,v 1.2 2018/03/15 17:38:58 penton Exp penton $'
	FF='(F12.6)'
	uSI=strupcase(strtrim(si,2))
	uAPER=strupcase(strtrim(apername,2))
	if verbose then message,/info,'Looking for SIAF info for '+uSI+' + '+uAPER
	xdet=reform(double(xydet[0,*]))
	ydet=reform(double(xydet[1,*]))
	n=n_elements(xdet)

	siaf=jwst_read_si_siaf(si,verbose=(verbose > 1))
	index=where(siaf.APERNAME eq uAPER,count)
	DetSciYAngle=(reform(siaf.DetSciYAngle[index]))[0]
	rDetSciYAngle=(DetSciYAngle)*!dtor
	DetSciParity=(reform(siaf.DetSciParity[index]))[0]
	<span class="comments">;</span>
	<span class="comments">; Give priority to passed in XSciRef and YSciRef</span>
	<span class="comments">;</span>
	XSciRef=(n_elements(XSciRef) eq 1 ? XSciRef : (reform(siaf.XSciRef[index]))[0])
	YSciRef=(n_elements(YSciRef) eq 1 ? YSciRef : (reform(siaf.YSciRef[index]))[0])
	XDetRef=(n_elements(XDetRef) eq 1 ? XDetRef : (reform(siaf.XDetRef[index]))[0])
	YDetRef=(n_elements(YDetRef) eq 1 ? YDetRef : (reform(siaf.YDetRef[index]))[0])

	psxSci=(reform(siaf.XSCISCALE[index]))[0]
	psySci=(reform(siaf.YSCISCALE[index]))[0]

	if verbose then begin
		message,/info,'APERNAME = '+uAPER+' ('+apername+')'
		message,/info,'[XSciref,YSciref] = ['+string1f(XSciRef,format=FF)+','+string1f(YSciRef,format=FF)+']'
		message,/info,'[XDetref,YDetref] = ['+string1f(XDetRef,format=FF)+','+string1f(YDetRef,format=FF)+']'
		message,/info,'Platescales [xSci,ySci] = ['+string1f(psxSci,format=FF)+','+string1f(psySci,format=FF)+']'
		message,/info,'DetSciYAngle = '+string1f(DetSciYAngle,format=FF)
		message,/info,'DetSciParity = '+string1i(DetSciParity)
	endif

	<span class="comments">;</span>
	<span class="comments">; [Xdet,Ydet]=[0,0] is [XSciRef,YSciRef]</span>
	<span class="comments">;eqn 1	xSci = [XSciRef] + [DetSciParity]((xDet – [XDetRef]) · cos([DetSciYAngle]) +(yDet – [YDetRef]) · sin([DetSciYAngle]))</span>
	<span class="comments">;eqn 2	ySci = [YSciRef] - (xDet – [XDetRef]) · sin([DetSciYAngle]) + (yDet – [YDetRef]) · cos([DetSciYAngle])</span>
	<span class="comments">;</span>
	<span class="comments">; Convert to [xSci,ySci]</span>
	<span class="comments">;</span>
	<span class="comments">; From Colin's ISR:</span>
	<span class="comments">;</span>
	<span class="comments">; XSci − XSciRef = DetSciParity[(XDet−XDetRef) * cos(DetSciYAngle)+ (YDet−YDetRef) *sin(DetSciYAngle)]</span>
	<span class="comments">; YSci − YSciRef = − (XDet − XDetRef ) sin(DetSciYAngle) + (YDet − YDetRef ) cos(DetSciYAngle)</span>
	<span class="comments">; XDet − XDetRef = DetSciParity(XSci − XSciRef ) cos(DetSciYAngle) − (YSci − YSciRef ) sin(DetSciYAngle)</span>
	<span class="comments">; YDet − YDetRef = DetSciParity(XSci − XSciRef ) sin(DetSciYAngle) + (YSci − YSciRef ) cos(DetSciYAngle)</span>

	dx=(xdet-XDetRef)
	dy=(ydet-YDetRef)
	xSci = XSciRef + (DetSciParity)* ( (dx * cos(rDetSciYAngle)) + (dy * sin(rDetSciYAngle)) )
	ySci = YSciRef -                   (dx * sin(rDetSciYAngle)) + (dy * cos(rDetSciYAngle))
	xySci=dblarr(2,n)
	xySci[0,*]=xSci
	xySci[1,*]=ySci
	xySCI={n:n,xSci:reform(xSci),ySci:reform(ySci),xySCI:xySCI,si:si,apername:apername,siaf:siaf,$
		DetSciParity:DetSciParity,DetSciYAngle:DetSciYAngle,rDetSciYAngle:rDetSciYAngle,$
		xdet:xdet,ydet:ydet,XSciRef:XSciRef,YSciRef:YSciRef,uAPER:uAPER}
	if debug then help,xySCI,/str
	return,xySCI
end
</code>
    </div>
  </body>
</html>